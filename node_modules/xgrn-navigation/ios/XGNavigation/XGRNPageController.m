//
//  XGRNController.m
//  ts
//
//  Created by nuomi on 2018/1/17.
//  Copyright © 2018年 Facebook. All rights reserved.
//

#import "XGRNPageController.h"
#import <React/RCTRootView.h>
#import "XGRNBridgeManager.h"
#import "UIViewController+XGRoute.h"
#import "RCTNavigationEmitter.h"

@interface XGRNPageController ()

@end

@implementation XGRNPageController

- (void)viewDidLoad {
    [super viewDidLoad];
    RCTRootView * view = [self createRCTRootView];
    if(view){
        self.view = view;
    } else {
        UIView * view = [[UIView alloc] initWithFrame:[UIApplication sharedApplication].keyWindow.frame];
        view.backgroundColor = [UIColor whiteColor];
        self.view = view;
        UILabel * label = [[UILabel alloc] init];
        label.text = @"找不到该页面~";
        label.textColor = [UIColor darkGrayColor];
        label.textAlignment = NSTextAlignmentCenter;
        CGFloat width = [UIScreen mainScreen].bounds.size.width;
        CGFloat height = [UIScreen mainScreen].bounds.size.height;
        label.frame = CGRectMake(0, 0, width, height);
        [view addSubview:label];
    }
}

#pragma mark - 创建根视图
- (RCTRootView *)createRCTRootView{
    //使用共享bridge
    RCTBridge * bridge = [[XGRNBridgeManager standardManager] getCommonBridge];
    //传递的值添加了route以后原封不动的丢给js
    NSMutableDictionary * props = [NSMutableDictionary dictionaryWithDictionary:self.pageConfig];
    if (self.route) {
        [props setObject:self.route forKey:@"route"];
        if (!XGSafeString(props[@"uniqueId"]) && XGSafeString(self.route[@"uniqueId"])) {
            [props setObject:self.route[@"uniqueId"] forKey:@"uniqueId"];
        }
    }
    return [[RCTRootView alloc] initWithBridge:bridge moduleName:[XGRNBridgeManager standardManager].moduleName initialProperties:props];
}

-(void)dealloc{
    if (self.xg_callBackArr && self.xg_callBackArr.count) {
        NSArray * arr = [NSArray arrayWithArray:self.xg_callBackArr];
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(4 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            for (NSString * callBackId in arr) {
                [RCTNavigationEmitter unregisterCallBackBy:callBackId];
            }
        });
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}


@end
