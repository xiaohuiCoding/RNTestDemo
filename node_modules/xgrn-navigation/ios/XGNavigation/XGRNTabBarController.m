//
//  XGRNTabBarController.m
//  ts
//
//  Created by nuomi on 2018/1/18.
//  Copyright © 2018年 Facebook. All rights reserved.
//

#import "XGRNTabBarController.h"
#import "XGRNPageController.h"
#import <React/RCTConvert.h>
#import "XGNavigationMacro.h"
#import "XGNavigation.h"
#import "UIViewController+XGRoute.h"
#import "RCTNavigationEmitter.h"
#define MoreThaniOS10 ([[UIDevice currentDevice].systemVersion doubleValue] >= 10.0)
@interface XGRNTabBarController ()<UITabBarControllerDelegate>

@end

@implementation XGRNTabBarController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.view.backgroundColor = [UIColor whiteColor];
    self.delegate = self;
    // Do any additional setup after loading the view.
}

- (BOOL)tabBarController:(UITabBarController *)tabBarController shouldSelectViewController:(UIViewController *)viewController{
    NSDictionary * tabRoute = viewController.route;
    NSDictionary * tabBarRoute = self.route;
    NSDictionary * object = @{@"tabBarRoute":tabBarRoute,@"tabRoute":tabRoute};
    [[NSNotificationCenter defaultCenter] postNotificationName:IOSTabClickNotificationEventName object:object];
    return NO;
}

// 设置tab配置
- (void)setTabConfigs:(NSDictionary *)tabConfigs{
    _tabConfigs = XGSafeDictionary(tabConfigs)?tabConfigs:@{};
    [self createSubViewControllers];
}

#pragma mark - 创建子页面
- (void)createSubViewControllers{
    NSArray * arr = self.tabConfigs[@"pages"];
    
    //是否为js的配置
    BOOL isJS = XGSafeNumber(self.tabConfigs[@"isJS"]) ? [(NSNumber *)self.tabConfigs[@"isJS"] boolValue] : NO;
    NSNumber * selectedIndex = self.tabConfigs[@"selectedIndex"];
    
    // 选中tab的icon的颜色
    NSString * tintColorStr = isJS ? self.tabConfigs[@"tintColor"] : nil;
    UIColor *tintColor = isJS ? tintColorStr != (id)[NSNull null] ? [RCTConvert UIColor:tintColorStr] : nil : XGSafeColor(self.tabConfigs[@"tintColor"]) ? self.tabConfigs[@"tintColor"] : nil;
    
    // tab的背景色(有值则barTranslucent的半透明失效)
    NSString * barTintColorStr = isJS ? self.tabConfigs[@"barTintColor"] : nil;
    UIColor *barTintColor = isJS ? barTintColorStr != (id)[NSNull null] ? [RCTConvert UIColor:barTintColorStr] : nil : XGSafeColor(self.tabConfigs[@"barTintColor"]) ? self.tabConfigs[@"barTintColor"] : nil;
    
    // 未选中tab的icon的颜色
    NSString * unselectedItemTintColorStr = self.tabConfigs[@"unselectedItemTintColor"];
    UIColor *unselectedItemTintColor = isJS ? unselectedItemTintColorStr != (id)[NSNull null] ? [RCTConvert UIColor:unselectedItemTintColorStr] : nil : XGSafeColor(self.tabConfigs[@"unselectedItemTintColor"]) ? self.tabConfigs[@"unselectedItemTintColor"] : nil;
    
    
    // tab的半透明效果(barTintColor有值则barTranslucent失效,效果为不透明)
    NSString *barTranslucent = self.tabConfigs[@"barTranslucent"];
    
    NSMutableArray * vcs = [NSMutableArray array];
    for (NSDictionary * item in arr) {
        NSString * title = item[@"tabBarTitle"];
        UIImage *iconImage = nil;
        UIImage *selectIconImage = nil;
        id  tabBarIcon = item[@"unSelectTabBarIcon"];
        if (tabBarIcon) {
            iconImage = isJS ? [RCTConvert UIImage:tabBarIcon] : XGSafeImage(tabBarIcon) ? tabBarIcon : nil ;
        }
        
        id  selectTabBarIcon = item[@"selectTabBarIcon"];
        if (selectTabBarIcon) {
            selectIconImage = isJS ? [RCTConvert UIImage:selectTabBarIcon] : XGSafeImage(selectTabBarIcon) ? selectTabBarIcon : nil;
        }
        UIViewController *tabVC = [XGNavigation getViewControllerBy:item];
        if (tabVC) {
            tabVC.tabBarItem.title = title;
            tabVC.tabBarItem.image = [iconImage imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal];
            tabVC.tabBarItem.selectedImage = [selectIconImage imageWithRenderingMode:UIImageRenderingModeAlwaysOriginal];
            [vcs addObject:tabVC];
        }
    }
    self.viewControllers = vcs;
    if(selectedIndex && [selectedIndex integerValue]){
        self.selectedIndex = [selectedIndex integerValue];
    }
    self.tabBar.tintColor = tintColor;
    self.tabBar.barTintColor = barTintColor;
    if(MoreThaniOS10){
        self.tabBar.unselectedItemTintColor = unselectedItemTintColor;
    }
    
    if (barTranslucent){
        self.tabBar.translucent = [barTranslucent boolValue] ? YES : NO;
    }
    
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */

@end
