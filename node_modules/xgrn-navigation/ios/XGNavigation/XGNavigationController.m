//
//  XGNavigationController.m
//  routedemo
//
//  Created by nuomi on 2018/1/22.
//  Copyright © 2018年 Facebook. All rights reserved.
//

#import "XGNavigationController.h"
#import <React/RCTRootView.h>
#import <React/RCTBundleURLProvider.h>
#import "UIViewController+XGRoute.h"

@interface XGNavigationController ()<UIGestureRecognizerDelegate>


@end

@interface XGNavigationController ()

@end

@implementation XGNavigationController

static XGNavigationController * _instance = nil;

+ (instancetype)shareInstance{
    static dispatch_once_t onceToken ;
    dispatch_once(&onceToken, ^{
        _instance = [[super allocWithZone:NULL] init] ;
    }) ;
    return _instance ;
}

+ (instancetype)allocWithZone:(struct _NSZone *)zone
{
    return [self shareInstance];
}

- (instancetype)copyWithZone:(struct _NSZone *)zone{
    return [XGNavigationController shareInstance] ;
}

+ (instancetype)createWithLaunchOptions:(NSDictionary *)launchOptions{
    UIViewController * vc = [[UIViewController alloc] init];
    vc.view.backgroundColor = [UIColor whiteColor];
    XGNavigationController * instanceVC = [[self alloc] initWithRootViewController:vc];
    instanceVC.launchOptions = launchOptions;
    instanceVC.navigationBarHidden = YES;
    return  instanceVC;
}

- (instancetype)initWithRootViewController:(UIViewController *)rootViewController{
    self = [super initWithRootViewController:rootViewController];
    if (self) {
        self.interactivePopGestureRecognizer.delegate = self;
    }
    return self;
}

- (BOOL)gestureRecognizerShouldBegin:(UIGestureRecognizer *)gestureRecognizer
{
    if (self.viewControllers.count <= 1){
        return NO;
    }
    UIViewController * stackTopVC = self.viewControllers[self.viewControllers.count -1];
    return [stackTopVC.allowPopGestureRecognizer boolValue];
}

- (void)back{
    [self popViewControllerAnimated:YES];
}


- (void)pushViewController:(UIViewController *)viewController animated:(BOOL)animated{
    if (self.viewControllers.count > 0) {
        viewController.hidesBottomBarWhenPushed = YES;
        UIButton * backButton = [UIButton buttonWithType:UIButtonTypeCustom];
        UIImage * image = [UIImage imageNamed:@"icon_header_back"];
        [backButton setImage:image forState:UIControlStateNormal];
        backButton.frame = (CGRect){CGPointZero, image.size};
        [backButton addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
        viewController.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:backButton];
    }
    [super pushViewController:viewController animated:animated];
}



- (void)viewDidLoad {
    [super viewDidLoad];
    self.interactivePopGestureRecognizer.enabled = YES;
    UIColor * color = [UIColor colorWithRed:.183 green:.183 blue:.183 alpha:1];
    self.navigationBar.titleTextAttributes = @{NSForegroundColorAttributeName: color, NSFontAttributeName : [UIFont systemFontOfSize:18]};
    self.navigationBar.tintColor = color;
    self.navigationBar.barTintColor = [UIColor whiteColor];
    
    [self.navigationBar setShadowImage:[self imageWithColor:[UIColor colorWithRed:0.87 green:0.87 blue:0.87 alpha:1] size:CGSizeMake([UIScreen mainScreen].bounds.size.width, 0.5)]];
    
    
}

- (UIImage *)imageWithColor:(UIColor *)color size:(CGSize)size {
    if (!color || size.width <= 0 || size.height <= 0) return nil;
    CGRect rect = CGRectMake(0.0f, 0.0f, size.width, size.height);
    UIGraphicsBeginImageContextWithOptions(rect.size, NO, 0);
    CGContextRef context = UIGraphicsGetCurrentContext();
    CGContextSetFillColorWithColor(context, color.CGColor);
    CGContextFillRect(context, rect);
    UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    return image;
}


- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}

/*
 #pragma mark - Navigation
 
 // In a storyboard-based application, you will often want to do a little preparation before navigation
 - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
 // Get the new view controller using [segue destinationViewController].
 // Pass the selected object to the new view controller.
 }
 */

@end
